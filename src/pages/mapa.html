<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mapa | Turismo Cómbita - Puntos de Interés</title>
    <meta name="description" content="Mapa interactivo de Cómbita con todos los puntos de interés: restaurantes, hospedajes, senderos, artesanos y sitios turísticos.">
    <script src="../assets/js/vendor/jquery.min.js"></script>
    <script src="../assets/js/vendor/main.js"></script>
    <link rel="stylesheet" href="../assets/css/vendor/bootstrap-grid.css">
    <link rel="stylesheet" href="../assets/css/vendor/style.css">
    <link rel="stylesheet" href="../assets/css/vendor/content-box.css">
    <link rel="stylesheet" href="../assets/media/icons/fontawesome/all.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/frailejon-theme.css">
    <link rel="icon" href="../assets/images/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        .map-page { height: 100vh; overflow: hidden; }

        /* Layout principal - ocupa todo debajo del nav */
        .map-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        /* Panel lateral */
        .map-sidebar {
            overflow-y: auto;
            padding: 12px;
            padding-top: 15px;
            background: #fafbfa;
            border-right: 1px solid #e9ecef;
            box-sizing: border-box;
        }
        .map-sidebar-title {
            font-size: 13px;
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding: 0 5px;
        }

        .map-poi-card {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        .map-poi-card:hover { border-color: #699073; transform: translateX(3px); }
        .map-poi-card.highlighted { border-color: #DDA15E; background: #fffdf8; }
        .map-poi-card h4 {
            font-size: 14px;
            color: #2d3e33;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .map-poi-card p {
            font-size: 12px;
            color: #888;
            margin: 0;
            line-height: 1.4;
        }
        .map-poi-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        .type-restaurante { background: #fff3e0; color: #ef6c00; }
        .type-hospedaje { background: #e8f5e9; color: #2e7d32; }
        .type-sendero { background: #e3f2fd; color: #1565c0; }
        .type-artesano { background: #f3e5f5; color: #7b1fa2; }
        .type-sitio { background: #fce4ec; color: #c62828; }

        /* Contenedor del mapa */
        .map-container {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        /* Filtros flotantes sobre el mapa */
        .map-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            pointer-events: none;
        }
        .map-controls-title {
            background: white;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            font-size: 16px;
            font-weight: 700;
            color: #2d3e33;
            pointer-events: auto;
            margin-right: 6px;
        }
        .map-controls-title i { color: #699073; margin-right: 6px; }
        .map-filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: white;
            color: #555;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            pointer-events: auto;
        }
        .map-filter-btn:hover { background: #f0f7f1; color: #699073; }
        .map-filter-btn.active { background: #699073; color: white; }
        .map-filter-btn .filter-count {
            background: rgba(0,0,0,0.1);
            padding: 1px 7px;
            border-radius: 10px;
            font-size: 11px;
        }
        .map-filter-btn.active .filter-count {
            background: rgba(255,255,255,0.25);
        }

        /* Mapa */
        #map {
            width: 100%;
            height: 100%;
        }

        /* Popup personalizado */
        .map-popup h4 {
            font-size: 15px;
            color: #2d3e33;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .map-popup .popup-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .map-popup p {
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .map-popup .popup-contact {
            font-size: 12px;
            color: #699073;
        }
        .map-popup .popup-contact i { margin-right: 4px; }

        /* Empty */
        .map-empty {
            text-align: center;
            padding: 40px 20px;
            color: #aaa;
        }
        .map-empty i { font-size: 30px; margin-bottom: 10px; display: block; }

        /* Toggle móvil mapa/lista */
        .mobile-toggle {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            html, body { overflow: hidden; }
            .map-page { height: 100vh; overflow: hidden; }
            main { height: calc(100vh - 100px) !important; margin-top: 100px !important; position: relative; }

            .map-layout {
                grid-template-columns: 1fr;
                height: 100%;
            }

            /* Toggle flotante */
            .mobile-toggle {
                display: flex;
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1100;
                background: white;
                border-radius: 25px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.25);
                overflow: hidden;
            }
            .mobile-toggle button {
                border: none;
                padding: 12px 24px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 6px;
                background: white;
                color: #555;
            }
            .mobile-toggle button.active {
                background: #699073;
                color: white;
            }
            .mobile-toggle button i { font-size: 16px; }

            /* Mapa ocupa todo por defecto */
            .map-container {
                height: 100%;
                order: 1;
            }
            .map-sidebar {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                max-height: none;
                height: 100%;
                border-right: none;
                background: #fafbfa;
                z-index: 2;
                display: none;
                padding-bottom: 70px;
                order: 2;
            }

            /* Cuando la lista está activa */
            .map-layout.show-list .map-sidebar {
                display: block;
            }
            .map-layout.show-list .map-container {
                display: none;
            }

            .map-controls { top: 10px; left: 10px; right: 10px; }
            .map-controls-title { font-size: 14px; padding: 6px 12px; }
            .map-filter-btn { padding: 6px 10px; font-size: 11px; }
        }
    </style>
</head>
<body class="page-main map-page">
    <div id="preloader"></div>
    <nav class="menu-classic menu-fixed align-right" data-menu-anima="fade-in">
        <div class="container">
            <div class="menu-brand">
                <a href="./index.html">
                    <img class="logo-default scroll-hide" src="../assets/images/icons/LOGO COLOR VECTORIZADO.png" alt="logo" />
                    <img class="logo-retina scroll-hide" src="../assets/images/icons/LOGO COLOR VECTORIZADO.png" alt="logo" />
                    <img class="logo-default scroll-show" src="../assets/images/icons/lgoo-dos.png" alt="logo" />
                    <img class="logo-retina scroll-show" src="../assets/images/icons/lgoo-dos.png" alt="logo" />
                </a>
            </div>
            <i class="menu-btn"></i>
            <div class="menu-cnt">
                <ul id="main-menu">
                    <li class="dropdown"><a href="./index.html">Inicio</a></li>
                    <li class="dropdown">
                        <a href="#">Descubre</a>
                        <ul>
                            <li><a href="./about.html">Acerca de</a></li>
                            <li class="dropdown-submenu">
                                <a>Imperdibles</a>
                                <ul>
                                    <li><a href="./food.html">Restaurantes</a></li>
                                    <li><a href="./shelters.html">Hospedajes</a></li>
                                    <li><a href="./events.html">Eventos</a></li>
                                    <li><a href="./artesanos-guias.html">Artesanos y Guías</a></li>
                                </ul>
                            </li>
                            <li class="dropdown-submenu">
                                <a>Explora Más</a>
                                <ul>
                                    <li><a href="./history.html">Historia</a></li>
                                    <li><a href="./gallery.html">Galería</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li><a href="./treks/index.html">Caminatas</a></li>
                    <li class="dropdown">
                        <a href="#">Planifica</a>
                        <ul>
                            <li><a href="./transporte.html">Cómo Llegar</a></li>
                            <li><a href="./mapa.html">Mapa</a></li>
                            <li><a href="./tips.html">Tips del Viajero</a></li>
                        </ul>
                    </li>
                    <li><a href="./blog.html">Blog</a></li>
                    <li><a href="./contacts.html">Contacto</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Toggle móvil mapa/lista -->
    <div class="mobile-toggle" id="mobileToggle">
        <button class="active" onclick="mobileView('mapa')"><i class="fas fa-map"></i> Mapa</button>
        <button onclick="mobileView('lista')"><i class="fas fa-list"></i> Lista</button>
    </div>

    <main style="margin-top:100px; height:calc(100vh - 100px); overflow:hidden;">
        <div class="map-layout">
            <div class="map-sidebar" id="mapSidebar">
                <div class="map-sidebar-title">Puntos de interés</div>
                <div id="poiList">
                    <div class="map-empty">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Cargando puntos...</p>
                    </div>
                </div>
            </div>
            <div class="map-container">
                <!-- Filtros flotantes sobre el mapa -->
                <div class="map-controls">
                    <span class="map-controls-title"><i class="fas fa-map-marked-alt"></i>Cómbita</span>
                    <button class="map-filter-btn active" data-filter="todos" onclick="filterMap('todos')">
                        <i class="fas fa-globe"></i> Todos
                    </button>
                    <button class="map-filter-btn" data-filter="restaurante" onclick="filterMap('restaurante')">
                        <i class="fas fa-utensils"></i> Restaurantes <span class="filter-count" id="count-restaurante">0</span>
                    </button>
                    <button class="map-filter-btn" data-filter="hospedaje" onclick="filterMap('hospedaje')">
                        <i class="fas fa-bed"></i> Hospedajes <span class="filter-count" id="count-hospedaje">0</span>
                    </button>
                    <button class="map-filter-btn" data-filter="sendero" onclick="filterMap('sendero')">
                        <i class="fas fa-hiking"></i> Senderos <span class="filter-count" id="count-sendero">0</span>
                    </button>
                    <button class="map-filter-btn" data-filter="sitio" onclick="filterMap('sitio')">
                        <i class="fas fa-star"></i> Sitios <span class="filter-count" id="count-sitio">0</span>
                    </button>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = window.location.origin + '/api';
        let map, markers = [], allPois = [];
        let currentFilter = 'todos';

        // Colores por tipo
        const typeColors = {
            restaurante: '#ef6c00',
            hospedaje: '#2e7d32',
            sendero: '#1565c0',
            artesano: '#7b1fa2',
            sitio: '#c62828'
        };
        const typeLabels = {
            restaurante: 'Restaurante',
            hospedaje: 'Hospedaje',
            sendero: 'Sendero',
            artesano: 'Artesano',
            sitio: 'Sitio Turístico'
        };

        function createIcon(color) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background:${color};width:14px;height:14px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -12]
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Inicializar mapa centrado en Cómbita
            map = L.map('map').setView([5.6272, -73.3297], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // Marcador principal de Cómbita
            L.marker([5.6272, -73.3297], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#2d3e33;width:20px;height:20px;border-radius:50%;border:4px solid #DDA15E;box-shadow:0 2px 8px rgba(0,0,0,0.4);"></div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                    popupAnchor: [0, -16]
                })
            }).addTo(map).bindPopup('<div class="map-popup"><h4>Cómbita</h4><p>Centro del municipio</p></div>');

            await loadAllPois();

            // Forzar recálculo del tamaño del mapa
            setTimeout(() => map.invalidateSize(), 200);
        });

        // Recalcular al cambiar tamaño de ventana
        window.addEventListener('resize', () => {
            if (map) map.invalidateSize();
        });

        async function loadAllPois() {
            const pois = [];

            // Puntos de interés predefinidos (sitios turísticos y senderos)
            const sitios = [
                { nombre: 'Laguna Rica', tipo: 'sendero', lat: 5.6450, lng: -73.3150, desc: 'Hermosa laguna de páramo rodeada de frailejones.' },
                { nombre: 'La Peña', tipo: 'sendero', lat: 5.6380, lng: -73.3050, desc: 'Formación rocosa con vistas panorámicas del valle.' },
                { nombre: 'El Tilín', tipo: 'sendero', lat: 5.6200, lng: -73.3100, desc: 'Cascada natural en medio del bosque nativo.' },
                { nombre: 'El Valle de los Frailejones', tipo: 'sendero', lat: 5.6500, lng: -73.3200, desc: 'Extenso valle de páramo con miles de frailejones.' },
                { nombre: 'Iglesia de Cómbita', tipo: 'sitio', lat: 5.6275, lng: -73.3300, desc: 'Iglesia colonial del centro del municipio.' },
                { nombre: 'Parque Principal', tipo: 'sitio', lat: 5.6270, lng: -73.3295, desc: 'Plaza central de Cómbita, corazón del pueblo.' }
            ];
            sitios.forEach(s => pois.push(s));

            // Cargar restaurantes
            try {
                const res = await fetch(`${API_URL}/restaurantes`);
                const restaurantes = await res.json();
                restaurantes.forEach(r => {
                    pois.push({
                        nombre: r.nombre,
                        tipo: 'restaurante',
                        lat: 5.6272 + (Math.random() - 0.5) * 0.008,
                        lng: -73.3297 + (Math.random() - 0.5) * 0.008,
                        desc: r.especialidad || r.tipo_cocina || 'Restaurante local',
                        telefono: r.telefono
                    });
                });
            } catch(e) {}

            // Cargar hospedajes
            try {
                const res = await fetch(`${API_URL}/hoteles`);
                const hoteles = await res.json();
                hoteles.forEach(h => {
                    pois.push({
                        nombre: h.nombre,
                        tipo: 'hospedaje',
                        lat: 5.6272 + (Math.random() - 0.5) * 0.01,
                        lng: -73.3297 + (Math.random() - 0.5) * 0.01,
                        desc: h.tipo || 'Hospedaje',
                        telefono: h.telefono
                    });
                });
            } catch(e) {}

            allPois = pois;
            updateCounts();
            renderPois(pois);
        }

        function updateCounts() {
            const counts = {};
            allPois.forEach(p => {
                counts[p.tipo] = (counts[p.tipo] || 0) + 1;
            });
            Object.keys(counts).forEach(tipo => {
                const el = document.getElementById(`count-${tipo}`);
                if (el) el.textContent = counts[tipo];
            });
        }

        function renderPois(pois) {
            // Limpiar marcadores existentes
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Renderizar lista
            const list = document.getElementById('poiList');
            if (pois.length === 0) {
                list.innerHTML = '<div class="map-empty"><i class="fas fa-map-marker-alt"></i><p>No hay puntos en esta categoría</p></div>';
                return;
            }

            list.innerHTML = pois.map((p, i) => `
                <div class="map-poi-card" onclick="focusPoi(${i})" id="poi-${i}">
                    <span class="map-poi-type type-${p.tipo}">${typeLabels[p.tipo] || p.tipo}</span>
                    <h4>${p.nombre}</h4>
                    <p>${p.desc || ''}${p.telefono ? ' <br><i class="fas fa-phone-alt" style="font-size:10px;color:#699073;"></i> ' + p.telefono : ''}</p>
                </div>
            `).join('');

            // Agregar marcadores al mapa
            pois.forEach((p, i) => {
                const marker = L.marker([p.lat, p.lng], {
                    icon: createIcon(typeColors[p.tipo] || '#666')
                }).addTo(map);

                marker.bindPopup(`
                    <div class="map-popup">
                        <span class="popup-type type-${p.tipo}" style="background:${typeColors[p.tipo]}20;color:${typeColors[p.tipo]}">${typeLabels[p.tipo] || p.tipo}</span>
                        <h4>${p.nombre}</h4>
                        <p>${p.desc || ''}</p>
                        ${p.telefono ? `<div class="popup-contact"><i class="fas fa-phone-alt"></i> ${p.telefono}</div>` : ''}
                    </div>
                `);

                marker.on('click', () => {
                    document.querySelectorAll('.map-poi-card').forEach(c => c.classList.remove('highlighted'));
                    const card = document.getElementById(`poi-${i}`);
                    if (card) {
                        card.classList.add('highlighted');
                        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });

                markers.push(marker);
            });

            // Ajustar vista al contenido
            if (markers.length > 1) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function filterMap(tipo) {
            currentFilter = tipo;

            // Actualizar botones
            document.querySelectorAll('.map-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === tipo);
            });

            // Filtrar
            const filtered = tipo === 'todos' ? allPois : allPois.filter(p => p.tipo === tipo);
            renderPois(filtered);
        }

        function mobileView(view) {
            const layout = document.querySelector('.map-layout');
            const btns = document.querySelectorAll('.mobile-toggle button');
            if (view === 'lista') {
                layout.classList.add('show-list');
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
            } else {
                layout.classList.remove('show-list');
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        function focusPoi(index) {
            const filtered = currentFilter === 'todos' ? allPois : allPois.filter(p => p.tipo === currentFilter);
            const poi = filtered[index];
            if (poi && markers[index]) {
                // En móvil, cambiar a vista mapa al tocar un POI
                if (window.innerWidth <= 768) {
                    mobileView('mapa');
                    setTimeout(() => {
                        map.setView([poi.lat, poi.lng], 16);
                        markers[index].openPopup();
                    }, 200);
                } else {
                    map.setView([poi.lat, poi.lng], 16);
                    markers[index].openPopup();
                }

                document.querySelectorAll('.map-poi-card').forEach(c => c.classList.remove('highlighted'));
                document.getElementById(`poi-${index}`)?.classList.add('highlighted');
            }
        }
    </script>
    <script src="../assets/js/vendor/parallax.min.js"></script>
</body>
</html>
